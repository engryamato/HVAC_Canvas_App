name: CI Pipeline

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Lint and Type Check
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./hvac-design-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './hvac-design-app/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type check
        run: npm run type-check
        continue-on-error: true  # Allow to continue for now due to existing errors

  # Job 2: Unit Tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./hvac-design-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './hvac-design-app/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:ci

      - name: Generate coverage report
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./hvac-design-app/coverage/coverage-final.json
          flags: unittests
          name: hvac-canvas-app
          fail_ci_if_error: false
          working-directory: ./hvac-design-app

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: ./hvac-design-app/coverage/
          retention-days: 30

  # Job 3: Build Application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    defaults:
      run:
        working-directory: ./hvac-design-app

    strategy:
      matrix:
        build-type: [development, production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './hvac-design-app/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Validate environment configuration
        run: npm run validate-env
        env:
          NODE_ENV: ${{ matrix.build-type }}

      - name: Build application (development)
        if: matrix.build-type == 'development'
        run: npm run build
        env:
          NODE_ENV: development

      - name: Build application (production)
        if: matrix.build-type == 'production'
        run: npm run build:prod
        env:
          NODE_ENV: production
          NEXT_PUBLIC_DEBUG_MODE: false

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ matrix.build-type }}
          path: ./hvac-design-app/.next/
          retention-days: 7

  # Job 4: Build Desktop App (Tauri)
  build-tauri:
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    needs: [lint-and-typecheck, test]

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    defaults:
      run:
        working-directory: ./hvac-design-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './hvac-design-app/package-lock.json'

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Node dependencies
        run: npm ci

      - name: Validate environment
        run: npm run validate-env
        env:
          NODE_ENV: production
          NEXT_PUBLIC_DEBUG_MODE: false

      - name: Build Tauri app
        run: npm run tauri:build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_DEBUG_MODE: false

      - name: Upload Tauri artifacts (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v6
        with:
          name: tauri-linux
          path: |
            ./hvac-design-app/src-tauri/target/release/bundle/deb/*.deb
            ./hvac-design-app/src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 7

      - name: Upload Tauri artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v6
        with:
          name: tauri-windows
          path: |
            ./hvac-design-app/src-tauri/target/release/bundle/msi/*.msi
            ./hvac-design-app/src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 7

      - name: Upload Tauri artifacts (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v6
        with:
          name: tauri-macos
          path: |
            ./hvac-design-app/src-tauri/target/release/bundle/dmg/*.dmg
            ./hvac-design-app/src-tauri/target/release/bundle/macos/*.app
          retention-days: 7

  # Job 5: Coverage Check
  coverage-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: ./hvac-design-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './hvac-design-app/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage report
        run: npm run test:coverage

      - name: Check coverage thresholds
        run: |
          echo "Checking coverage thresholds..."
          npm run test:coverage:check || echo "::warning::Coverage below target threshold"

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('./hvac-design-app/coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;

            const comment = `## üìä Test Coverage Report

            | Metric | Coverage | Status |
            |--------|----------|--------|
            | **Statements** | ${total.statements.pct}% | ${total.statements.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | **Branches** | ${total.branches.pct}% | ${total.branches.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | **Functions** | ${total.functions.pct}% | ${total.functions.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | **Lines** | ${total.lines.pct}% | ${total.lines.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |

            **Target:** 70% coverage across all metrics
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
